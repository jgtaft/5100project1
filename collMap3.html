<!-- Data Driven Web Applications
	 Tuesday March 7,2017
	 Luis Plaz
	 Jessie Taft
	 Kevin Park
	-->

<!-- Collisions.csv is from the NYC Open data initiative. It was cleaned to remove accidents
where nobody was injured or killed, and to remove data with missing lat/long coordinates,
borough names, and accident causes. -->

<html>
	<head>

		<title>Project 1 : Static Data Visualization</title>

		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="http://d3js.org/topojson.v2.min.js"></script>
		<script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>

		<link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet">

		<style>
			body { background-color: #f2f2f2}
			svg#mapDiv { display: block; margin: auto; }
			svg text#title { fill: Grey; font-family: Anton; }
			svg path#pointerpath { stroke-width: 2; fill: none; }
			svg text#borotext { font-size: 30; font-family: Anton; }

		</style>

	</head>

	<body>

		<div id="map"></div>
		<script>

		var width = 1270,
		height = 900;

		var col_set = [];
		var reason_dict = {};
		var borough_info = {};
		var i = 0;

		var boroughs;
		var comms;
		var popdata;

		var projection = d3.geoAlbersUsa();
		var pathGenerator = d3.geoPath().projection(projection);

		var map = d3.select("#map").append("svg")
		.attr("id", "mapDiv")
		.attr("width", width)
		.attr("height", height);

		var fillArr = ["#72e5ef", "#a6b6f9", "#e3a0fa", "#a7e831", "#f8d147"];
		var fillArrDarker = ["#176970", "#4e5987", "#405e09", "#4f2b5b", "#7c640c"];
		var fillArrLighter = ["#d9f7f9", "#d7dcef", "#efffd3", "#e5d7ea", "#f2e5b8"];
		var boroArr = ["BRONX", "MANHATTAN", "QUEENS", "BROOKLYN", "STATEN ISLAND"];

		class collision {
			constructor(date, time, long, lat, borough, injuries, deaths,reason) {
				this.date = date;
				this.time = time;
				this.long = long;
				this.lat = lat;
				this.borough = borough;
				this.injuries = injuries;
				this.deaths = deaths;
				this.reason = reason;
			}
		};

		d3.queue()
		.defer(d3.json, "boros.json")
		.defer(d3.json, "communities.json")
		.defer(d3.csv, "collisions2.csv")
		.await(analyze);

		function analyze(error, rawBoros, rawComms, colldata) {

			if(error) { console.log(error); }

			boroughs = rawBoros;
			comms = rawComms;

			colldata.forEach(function(col) {

				if(col.DATE != "" && col.TIME != "" && col.BOROUGH != "" && col.LONGITUDE != "" && col.LATITUDE != "" && col['PERSONS INJURED'] != "" && col['PERSONS KILLED'] != "" && col['VEHICLE 1 FACTOR'] != "" ){
					var new_collision = new collision(col.DATE,col.TIME,col.LONGITUDE,col.LATITUDE,col.BOROUGH,col.INJURIES,col.DEATHS,col['VEHICLE 1 FACTOR'])
					col_set.push(new_collision);
				}
				i++;

			});
				topReasons(col_set);
				showMapLight();
				// showMapDark();

		};

		function topReasons (colArr){
			for (index in colArr) {
				if(colArr[index].borough in reason_dict == false){
					reason_dict[colArr[index].borough] = {};
					borough_info[colArr[index].borough] = {};
				}else{
					if(colArr[index].reason in reason_dict[colArr[index].borough] == false){
						reason_dict[colArr[index].borough][colArr[index].reason] = 1;
					}else{
						reason_dict[colArr[index].borough][colArr[index].reason] += 1;
					}
				}
			}

			setReasons(reason_dict);
		};

		function setReasons(dictionary) {
			var wierdest_reason = "";
			var rare_factor = 1;

			for (var borough in dictionary) {
				var total_colisions = 0;
				borough_info[borough]["total"] = 0;

				for (var reason in dictionary[borough]) {
					var value = dictionary[borough][reason]
					total_colisions += value

					if(rare_factor == value && reason != "Unspecified"){

						if(reason in borough_info[borough] == false){
							borough_info[borough][reason] = value;
						}else{
							borough_info[borough][reason] += 1;
						};
					};

				};
				borough_info[borough]["total"] = total_colisions;
			};

		};

		// function showMapDark(){

		// 	map.append("text")
		// 		.attr("id", "title")
		// 		.attr("x", width/2)
		// 		.attr("y", 50)
		// 		.attr("text-anchor", "middle")
		// 		.text("MOTOR VEHICLE ACCIDENT INJURIES IN NYC");

		// 	map.append("rect")
		// 		.attr("height", height)
		// 		.attr("width", width)
		// 		.attr("fill", "#000033");

		// 	projection.fitExtent([[0,100], [610, map.attr("height")]], boroughs);

		// 	var boroughpaths = map.selectAll("path.boroughs").data(boroughs.features);

		// 	boroughpaths.enter().append("path")
		// 		.attr("class", "boroughs")
		// 		.attr("fill", function(){return fillArrDarker.pop()})
		// 		.merge(boroughpaths)
		// 		.attr("d", function(boroughs){ return pathGenerator(boroughs); })
		// 		.attr("stroke", "none");

		// 	var commpaths = map.selectAll("path.comms").data(comms.features);

		// 	commpaths.enter().append("path")
		// 		.attr("class", "comms")
		// 		.merge(commpaths)
		// 		.attr("d", function(comms){ return pathGenerator(comms); })
		// 		.attr("fill", "none")
		// 		.attr("stroke", "#8080ff")
		// 		.attr("stroke-width", "0.5");

		// 	for(i=0; i<col_set.length; i++){
		// 		map.append("circle")
		// 			.attr("cx", projection([col_set[i].long,col_set[i].lat])[0])
		// 			.attr("cy", projection([col_set[i].long,col_set[i].lat])[1])
		// 			.attrs(setAttrs());
		// 	};

		// 	function setAttrs(){
		// 		if(col_set[i].deaths>=1 ){
		// 			return {r: 2 * Math.sqrt(col_set[i].deaths), fill: "#ffff99", opacity: 1, stroke: "#ffffff"};
		// 		}else if(col_set[i].injuries>=4){
		// 			return {r: Math.sqrt(col_set[i].injuries), fill: "#ffff99", opacity: .5};
		// 		}
		// 	};

		// 	showByBoroughDark();
		// };

		// function showByBoroughDark(){

		// 	for(j=0;j<boroArr.length; j++){

		// 		group = map.append("g")
		// 			.attr("id", boroArr[j])

		// 		group.append("text")
		// 			.attr("id", "borotext")
		// 			.attr("x", 800)
		// 			.attr("y", (j*140)+ 150)
		// 			.attr("text-anchor", "end")
		// 			.attr("fill", "#cc9900")
		// 			.text(boroArr[j]);

		// 		group.append("rect")
		// 			.attr("x", 810)
		// 			.attr("y", (j*140) + 130)
		// 			.attr("height", 120)
		// 			.attr("width", 200)
		// 			.attr("stroke", "#cc9900")
		// 			.attr("stroke-width", 2)
		// 			.attr("fill", "none");
		// 	}

		// 	map.append("path")
		// 		.attr("id", "pointerpath")
		// 		.attr("d", "M 350 200 L 700 155 L 810 155")
		// 		.attr("stroke", "#cc9900");

		// 	map.append("path")
		// 		.attr("id", "pointerpath")
		// 		.attr("d", "M 250 350 L 650 295 L 810 295")
		// 		.attr("stroke", "#cc9900");

		// 	map.append("path")
		// 		.attr("id", "pointerpath")
		// 		.attr("d", "M 450 400 L 690 435 L 810 435")
		// 		.attr("stroke", "#cc9900");

		// 	map.append("path")
		// 		.attr("id", "pointerpath")
		// 		.attr("d", "M 320 550 L 680 575 L 810 575")
		// 		.attr("stroke", "#cc9900");

		// 	map.append("path")
		// 		.attr("id", "pointerpath")
		// 		.attr("d", "M 120 720 L 620 715 L 810 715")
		// 		.attr("stroke", "#cc9900");
		// };

		function showMapLight(){

			map.append("text")
				.attr("id", "title")
				.attr("x", width/2)
				.attr("y", 50)
				.attr("text-anchor", "middle")
				.attr("font-size", 40)
				.text("MOTOR VEHICLE ACCIDENT INJURIES IN NYC:");

			map.append("text")
				.attr("id", "title")
				.attr("x", width/2)
				.attr("y", 100)
				.attr("text-anchor", "middle")
				.attr("font-size", 50)
				.text("THE SCARY, THE RARE, AND THE WEIRD");

			map.append("text")
				.attr("x", width/2)
				.attr("y", 120)
				.attr("text-anchor", "middle")
				.attr("fill", "Grey")
				.attr("font-style", "italic")
				.text("January 1st through April 30th, 2015");

			projection.fitExtent([[0,160], [610, map.attr("height")]], boroughs);

			boroughpaths = map.selectAll("path.boroughs").data(boroughs.features);

		    boroughpaths.enter().append("path")
		    .attr("class", "boroughs")
		   	.attr("fill", function(){return fillArr.pop()})
		    .merge(boroughpaths)
		    .attr("d", function(boroughs){ return pathGenerator(boroughs); })
		    .attr("stroke", "none")
		    .attr("opacity","0.7");

	  		var commpaths = map.selectAll("path.tracts").data(comms.features);

			commpaths.enter().append("path")
		    .attr("class", "comms")
		    .merge(commpaths)
		    .attr("d", function(comms){ return pathGenerator(comms); })
		    .attr("fill", "none")
		    .attr("stroke", "#FFFFFF")
		    .attr("stroke-width", "0.5");

	    for(i=0; i<col_set.length; i++){
	    	map.append("circle")
			    .attr("cx", projection([col_set[i].long,col_set[i].lat])[0])
			    .attr("cy", projection([col_set[i].long,col_set[i].lat])[1])
			    .attrs(setAttrs);
			};

			function setAttrs(){
				if(col_set[i].deaths>=1){
					return {r: 3, fill: "#FF280D", opacity: 1};
				}else if(col_set[i].injuries>=1){
					return {r: Math.sqrt(col_set[i].injuries) , fill: "#472700", opacity: .7};
				}
			};

			showByBoroughLight();
		};


		function showByBoroughLight(){

			for(j=0;j<boroArr.length; j++){

				line = 10;

				group = map.append("g")
					.attr("id", boroArr[j])

				group.append("text")
					.attr("id", "borotext")
					.attr("x", 800)
					.attr("y", (j*140)+ 200)
					.attr("text-anchor", "end")
					.attr("fill", fillArrDarker[j])
					.text(boroArr[j]);

				group.append("text")
					.attr("x", 950)
					.attr("y", (j*140)+ 150)
					.attr("text-anchor", "middle")
					.attr("fill", fillArrDarker[j])
					.attr("font-size", 20)
					.attr("font-family", "Anton")
					.text("Total Incidents : " + borough_info[boroArr[j]]["total"]);


				for (var key in borough_info[boroArr[j]]) {

					if(key != "total"){
						group.append("text")
						.attr("x", 950)
						.attr("y", (j*140)+ 150 + line)
						.attr("text-anchor", "middle")
						.attr("font-size" , "12px")
						.attr("fill", fillArrDarker[j])
						.text(key);
					};

					line += 12;

				};

				group.append("rect")
					.attr("x", 810)
					.attr("y", (j*140) + 120)
					.attr("height", 135)
					.attr("width", 275)
					.attr("stroke", fillArrDarker[j])
					.attr("stroke-width", 2)
					.attr("fill", "none");
			}


		legend = map.append("g")
			.attr("id", "legend");

		legend.append("text")
			.attr("x", 110)
			.attr("y", 135)
			.attr("text-anchor", "middle")
			.attr("fill", fillArrDarker[j])
			.attr("font-weight","bold")
			.text("Number Injured");

		legend.append("text")
			.attr("x", 70)
			.attr("y", 165)
			.attr("text-anchor", "middle")
			.attr("fill", "black")
			.attr("font-weight","bold")
			.attr("font-size", "12px")
			.text("1");

		legend.append("text")
			.attr("x", 70)
			.attr("y", 255)
			.attr("text-anchor", "middle")
			.attr("fill", "black")
			.attr("font-weight","bold")
			.attr("font-size", "12px")
			.text("64");

		legend.append("circle")
			.attr("cx", 120)
			.attr("cy", 160)
			.attr("r", Math.sqrt(1))
			.attr("fill", "#472700")
			.attr("opacity" ,".7");

		legend.append("circle")
			.attr("cx", 120)
			.attr("cy", 185)
			.attr("r", Math.sqrt(10))
			.attr("fill", "#472700")
			.attr("opacity" ,".7");

		legend.append("circle")
			.attr("cx", 120)
			.attr("cy", 210)
			.attr("r", Math.sqrt(32))
			.attr("fill", "#472700")
			.attr("opacity" ,".7");

		legend.append("circle")
			.attr("cx", 120)
			.attr("cy", 250)
			.attr("r", Math.sqrt(64))
			.attr("fill", "#472700")
			.attr("opacity" ,".7");

		legend.append("rect")
			.attr("x", 45)
			.attr("y", 115)
			.attr("height", 200)
			.attr("width", 130)
			.attr("stroke", "black")
			.attr("stroke-width", 2)
			.attr("fill", "none");

		legend.append("path")
			.attr("id", "legendPath")
			.attr("d", "M 70 167 L 70 245")
			.attr("stroke", "black");

		map.append("path")
			.attr("id", "pointerpath")
			.attr("d", "M 350 200 L 700 155 L 810 155")
			.attr("stroke", fillArrDarker[0]);

		map.append("path")
			.attr("id", "pointerpath")
			.attr("d", "M 250 350 L 650 295 L 810 295")
			.attr("stroke", fillArrDarker[1]);

		map.append("path")
			.attr("id", "pointerpath")
			.attr("d", "M 450 400 L 690 435 L 810 435")
			.attr("stroke", fillArrDarker[2]);

		map.append("path")
			.attr("id", "pointerpath")
			.attr("d", "M 320 550 L 680 575 L 810 575")
			.attr("stroke", fillArrDarker[3]);

		map.append("path")
			.attr("id", "pointerpath")
			.attr("d", "M 120 720 L 620 715 L 810 715")
			.attr("stroke", fillArrDarker[4]);
		};


				//UNCOMMENT THE CODE BELOW TO GET GREY GRIDLINES WHICH ARE USEFUL FOR PLACING THINGS

			// for (k=0;k<12;k++){
			// 	map.append("line")
			// 		.attr("x1", (k*100) + 100)
			// 		.attr("y1", 0)
			// 		.attr("x2", (k*100) + 100)
			// 		.attr("y2", 900)
			// 		.attr("stroke", "LightGrey");
			// }
			//
			// for (k=0;k<8;k++){
			// 	map.append("line")
			// 		.attr("x1", 0)
			// 		.attr("y1", (k*100) + 100)
			// 		.attr("x2", 1200)
			// 		.attr("y2", (k*100) + 100)
			// 		.attr("stroke", "LightGrey");
			// }

		</script>

	</body>

</html>
